<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><meta name="generator" content="Gatsby 4.20.0"/><meta name="description" content="Introduction “A rate limiter caps how many requests a sender can issue in a specific time window. It then blocks requests once the cap is reached.” Some major…" data-gatsby-head="true"/><meta property="og:title" content="Designing a bursty a rate limiter" data-gatsby-head="true"/><meta property="og:description" content="Introduction “A rate limiter caps how many requests a sender can issue in a specific time window. It then blocks requests once the cap is reached.” Some major…" data-gatsby-head="true"/><meta property="og:type" content="website" data-gatsby-head="true"/><meta name="github:card" content="summary" data-gatsby-head="true"/><meta name="github:creator" content="samya-ak" data-gatsby-head="true"/><meta name="github:title" content="Designing a bursty a rate limiter" data-gatsby-head="true"/><meta name="github:description" content="Introduction “A rate limiter caps how many requests a sender can issue in a specific time window. It then blocks requests once the cap is reached.” Some major…" data-gatsby-head="true"/><style data-href="/styles.23c6c1324930951be7e0.css" data-identity="gatsby-global-css">@font-face{font-display:swap;font-family:Montserrat;font-style:normal;font-weight:100;src:local("Montserrat Thin "),local("Montserrat-Thin"),url(/static/montserrat-latin-100-8d7d79679b70dbe27172b6460e7a7910.woff2) format("woff2"),url(/static/montserrat-latin-100-ec38980a9e0119a379e2a9b3dbb1901a.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:italic;font-weight:100;src:local("Montserrat Thin italic"),local("Montserrat-Thinitalic"),url(/static/montserrat-latin-100italic-e279051046ba1286706adc886cf1c96b.woff2) format("woff2"),url(/static/montserrat-latin-100italic-3b325a3173c8207435cd1b76e19bf501.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:normal;font-weight:200;src:local("Montserrat Extra Light "),local("Montserrat-Extra Light"),url(/static/montserrat-latin-200-9d266fbbfa6cab7009bd56003b1eeb67.woff2) format("woff2"),url(/static/montserrat-latin-200-2d8ba08717110d27122e54c34b8a5798.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:italic;font-weight:200;src:local("Montserrat Extra Light italic"),local("Montserrat-Extra Lightitalic"),url(/static/montserrat-latin-200italic-6e5b3756583bb2263eb062eae992735e.woff2) format("woff2"),url(/static/montserrat-latin-200italic-a0d6f343e4b536c582926255367a57da.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:normal;font-weight:300;src:local("Montserrat Light "),local("Montserrat-Light"),url(/static/montserrat-latin-300-00b3e893aab5a8fd632d6342eb72551a.woff2) format("woff2"),url(/static/montserrat-latin-300-ea303695ceab35f17e7d062f30e0173b.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:italic;font-weight:300;src:local("Montserrat Light italic"),local("Montserrat-Lightitalic"),url(/static/montserrat-latin-300italic-56f34ea368f6aedf89583d444bbcb227.woff2) format("woff2"),url(/static/montserrat-latin-300italic-54b0bf2c8c4c12ffafd803be2466a790.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:normal;font-weight:400;src:local("Montserrat Regular "),local("Montserrat-Regular"),url(/static/montserrat-latin-400-b71748ae4f80ec8c014def4c5fa8688b.woff2) format("woff2"),url(/static/montserrat-latin-400-0659a9f4e90db5cf51b50d005bff1e41.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:italic;font-weight:400;src:local("Montserrat Regular italic"),local("Montserrat-Regularitalic"),url(/static/montserrat-latin-400italic-6eed6b4cbb809c6efc7aa7ddad6dbe3e.woff2) format("woff2"),url(/static/montserrat-latin-400italic-7583622cfde30ae49086d18447ab28e7.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:normal;font-weight:500;src:local("Montserrat Medium "),local("Montserrat-Medium"),url(/static/montserrat-latin-500-091b209546e16313fd4f4fc36090c757.woff2) format("woff2"),url(/static/montserrat-latin-500-edd311588712a96bbf435fad264fff62.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:italic;font-weight:500;src:local("Montserrat Medium italic"),local("Montserrat-Mediumitalic"),url(/static/montserrat-latin-500italic-c90ced68b46050061d1a41842d6dfb43.woff2) format("woff2"),url(/static/montserrat-latin-500italic-5146cbfe02b1deea5dffea27a5f2f998.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:normal;font-weight:600;src:local("Montserrat SemiBold "),local("Montserrat-SemiBold"),url(/static/montserrat-latin-600-0480d2f8a71f38db8633b84d8722e0c2.woff2) format("woff2"),url(/static/montserrat-latin-600-b77863a375260a05dd13f86a1cee598f.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:italic;font-weight:600;src:local("Montserrat SemiBold italic"),local("Montserrat-SemiBolditalic"),url(/static/montserrat-latin-600italic-cf46ffb11f3a60d7df0567f8851a1d00.woff2) format("woff2"),url(/static/montserrat-latin-600italic-c4fcfeeb057724724097167e57bd7801.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:normal;font-weight:700;src:local("Montserrat Bold "),local("Montserrat-Bold"),url(/static/montserrat-latin-700-7dbcc8a5ea2289d83f657c25b4be6193.woff2) format("woff2"),url(/static/montserrat-latin-700-99271a835e1cae8c76ef8bba99a8cc4e.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:italic;font-weight:700;src:local("Montserrat Bold italic"),local("Montserrat-Bolditalic"),url(/static/montserrat-latin-700italic-c41ad6bdb4bd504a843d546d0a47958d.woff2) format("woff2"),url(/static/montserrat-latin-700italic-6779372f04095051c62ed36bc1dcc142.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:normal;font-weight:800;src:local("Montserrat ExtraBold "),local("Montserrat-ExtraBold"),url(/static/montserrat-latin-800-db9a3e0ba7eaea32e5f55328ace6cf23.woff2) format("woff2"),url(/static/montserrat-latin-800-4e3c615967a2360f5db87d2f0fd2456f.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:italic;font-weight:800;src:local("Montserrat ExtraBold italic"),local("Montserrat-ExtraBolditalic"),url(/static/montserrat-latin-800italic-bf45bfa14805969eda318973947bc42b.woff2) format("woff2"),url(/static/montserrat-latin-800italic-fe82abb0bcede51bf724254878e0c374.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:normal;font-weight:900;src:local("Montserrat Black "),local("Montserrat-Black"),url(/static/montserrat-latin-900-e66c7edc609e24bacbb705175669d814.woff2) format("woff2"),url(/static/montserrat-latin-900-8211f418baeb8ec880b80ba3c682f957.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:italic;font-weight:900;src:local("Montserrat Black italic"),local("Montserrat-Blackitalic"),url(/static/montserrat-latin-900italic-4454c775e48152c1a72510ceed3603e2.woff2) format("woff2"),url(/static/montserrat-latin-900italic-efcaa0f6a82ee0640b83a0916e6e8d68.woff) format("woff")}@font-face{font-display:swap;font-family:Merriweather;font-style:normal;font-weight:300;src:local("Merriweather Light "),local("Merriweather-Light"),url(/static/merriweather-latin-300-fc117160c69a8ea0851b26dd14748ee4.woff2) format("woff2"),url(/static/merriweather-latin-300-58b18067ebbd21fda77b67e73c241d3b.woff) format("woff")}@font-face{font-display:swap;font-family:Merriweather;font-style:italic;font-weight:300;src:local("Merriweather Light italic"),local("Merriweather-Lightitalic"),url(/static/merriweather-latin-300italic-fe29961474f8dbf77c0aa7b9a629e4bc.woff2) format("woff2"),url(/static/merriweather-latin-300italic-23c3f1f88683618a4fb8d265d33d383a.woff) format("woff")}@font-face{font-display:swap;font-family:Merriweather;font-style:normal;font-weight:400;src:local("Merriweather Regular "),local("Merriweather-Regular"),url(/static/merriweather-latin-400-d9479e8023bef9cbd9bf8d6eabd6bf36.woff2) format("woff2"),url(/static/merriweather-latin-400-040426f99ff6e00b86506452e0d1f10b.woff) format("woff")}@font-face{font-display:swap;font-family:Merriweather;font-style:italic;font-weight:400;src:local("Merriweather Regular italic"),local("Merriweather-Regularitalic"),url(/static/merriweather-latin-400italic-2de7bfeaf08fb03d4315d49947f062f7.woff2) format("woff2"),url(/static/merriweather-latin-400italic-79db67aca65f5285964ab332bd65f451.woff) format("woff")}@font-face{font-display:swap;font-family:Merriweather;font-style:normal;font-weight:700;src:local("Merriweather Bold "),local("Merriweather-Bold"),url(/static/merriweather-latin-700-4b08e01d805fa35d7bf777f1b24314ae.woff2) format("woff2"),url(/static/merriweather-latin-700-22fb8afba4ab1f093b6ef9e28a9b6e92.woff) format("woff")}@font-face{font-display:swap;font-family:Merriweather;font-style:italic;font-weight:700;src:local("Merriweather Bold italic"),local("Merriweather-Bolditalic"),url(/static/merriweather-latin-700italic-cd92541b177652fffb6e3b952f1c33f1.woff2) format("woff2"),url(/static/merriweather-latin-700italic-f87f3d87cea0dd0979bfc8ac9ea90243.woff) format("woff")}@font-face{font-display:swap;font-family:Merriweather;font-style:normal;font-weight:900;src:local("Merriweather Black "),local("Merriweather-Black"),url(/static/merriweather-latin-900-f813fc6a4bee46eda5224ac7ebf1b7be.woff2) format("woff2"),url(/static/merriweather-latin-900-5d4e42cb44410674acd99153d57df032.woff) format("woff")}@font-face{font-display:swap;font-family:Merriweather;font-style:italic;font-weight:900;src:local("Merriweather Black italic"),local("Merriweather-Blackitalic"),url(/static/merriweather-latin-900italic-b7901d85486871c1779c0e93ddd85656.woff2) format("woff2"),url(/static/merriweather-latin-900italic-9647f9fdab98756989a8a5550eb205c3.woff) format("woff")}


/*! normalize.css v8.0.1 | MIT License | github.com/necolas/normalize.css */html{-webkit-text-size-adjust:100%;line-height:1.15}body{margin:0}main{display:block}h1{font-size:2em;margin:.67em 0}hr{box-sizing:content-box;height:0;overflow:visible}pre{font-family:monospace,monospace;font-size:1em}a{background-color:transparent}abbr[title]{border-bottom:none;text-decoration:underline;-webkit-text-decoration:underline dotted;text-decoration:underline dotted}b,strong{font-weight:bolder}code,kbd,samp{font-family:monospace,monospace;font-size:1rem}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;line-height:1.15;margin:0}button,input{overflow:visible}button,select{text-transform:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{padding:.35em .75em .625em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}progress{vertical-align:baseline}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}details{display:block}summary{display:list-item}[hidden]{display:none}:root{--maxWidth-none:"none";--maxWidth-xs:20rem;--maxWidth-sm:24rem;--maxWidth-md:28rem;--maxWidth-lg:32rem;--maxWidth-xl:36rem;--maxWidth-2xl:42rem;--maxWidth-3xl:48rem;--maxWidth-4xl:56rem;--maxWidth-full:"100%";--maxWidth-wrapper:var(--maxWidth-3xl);--spacing-px:"1px";--spacing-0:0;--spacing-1:0.25rem;--spacing-2:0.5rem;--spacing-3:0.75rem;--spacing-4:1rem;--spacing-5:1.25rem;--spacing-6:1.5rem;--spacing-8:2rem;--spacing-10:2.5rem;--spacing-12:3rem;--spacing-16:4rem;--spacing-20:5rem;--spacing-24:6rem;--spacing-32:8rem;--fontFamily-sans:firaCode-regular,Montserrat,system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";--fontFamily-serif:firaCode-regular,"Merriweather","Georgia",Cambria,"Times New Roman",Times,serif;--font-body:var(--fontFamily-serif);--font-heading:var(--fontFamily-sans);--fontWeight-normal:400;--fontWeight-medium:500;--fontWeight-semibold:600;--fontWeight-bold:700;--fontWeight-extrabold:800;--fontWeight-black:900;--fontSize-root:16px;--lineHeight-none:1;--lineHeight-tight:1.1;--lineHeight-normal:1.5;--lineHeight-relaxed:1.625;--fontSize-0:0.833rem;--fontSize-1:1.1rem;--fontSize-2:1.2rem;--fontSize-3:1.44rem;--fontSize-4:1.728rem;--fontSize-5:2.074rem;--fontSize-6:2.488rem;--fontSize-7:2.986rem;--color-primary:#000;--color-text:#2e353f;--color-text-light:silver;--color-heading:#1a202c;--color-heading-black:#000;--color-accent:#d1dce5}*,:after,:before{box-sizing:border-box}html{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;font-size:var(--fontSize-root);line-height:var(--lineHeight-normal)}body{color:var(--color-text);font-family:var(--font-body);font-size:var(--fontSize-1)}footer{padding:var(--spacing-6) var(--spacing-0)}hr{background:var(--color-accent);border:0;height:1px}h1,h2,h3,h4,h5,h6{font-family:var(--font-heading);letter-spacing:-.025em;line-height:var(--lineHeight-tight);margin-bottom:var(--spacing-6);margin-top:var(--spacing-6)}h2,h3,h4,h5,h6{color:var(--color-heading);font-weight:var(--fontWeight-bold)}h1{color:var(--color-heading-black);font-weight:var(--fontWeight-black)}h1,h2{font-size:var(--fontSize-5)}h3{font-size:var(--fontSize-4)}h4{font-size:var(--fontSize-3)}h5{font-size:var(--fontSize-2)}h6{font-size:var(--fontSize-1)}h1>a,h2>a,h3>a,h4>a,h5>a,h6>a{color:inherit;text-decoration:none}p{--baseline-multiplier:0.179;--x-height-multiplier:0.35;line-height:var(--lineHeight-relaxed);margin:var(--spacing-0) var(--spacing-0) var(--spacing-8) var(--spacing-0)}ol,p,ul{padding:var(--spacing-0)}ol,ul{list-style-image:none;list-style-position:outside;margin-left:var(--spacing-0);margin-right:var(--spacing-0)}ol li,ul li{padding-left:var(--spacing-0)}li>p{margin-bottom:calc(var(--spacing-8)/2)}li :last-child{margin-bottom:var(--spacing-0)}li>ul{margin-left:var(--spacing-8);margin-top:calc(var(--spacing-8)/2)}blockquote{border-left:var(--spacing-1) solid var(--color-primary);color:var(--color-text);font-size:var(--fontSize-1);font-style:italic;margin-bottom:var(--spacing-8);margin-left:calc(var(--spacing-6)*-1);margin-right:var(--spacing-8);padding:var(--spacing-0) var(--spacing-0) var(--spacing-0) var(--spacing-6)}blockquote>:last-child{margin-bottom:var(--spacing-0)}blockquote>ol,blockquote>ul{list-style-position:inside}table{border-collapse:collapse;border-spacing:.25rem;margin-bottom:var(--spacing-8);width:100%}table thead tr th{border-bottom:1px solid var(--color-accent)}.highlight{background:linear-gradient(180deg,rgba(0,0,0,.2) 0,rgba(0,0,0,.2));background-position:0 100%;background-repeat:repeat-x;background-size:4px 4px;color:var(--color-primary);text-decoration:none;transition:background-size .2s}.highlight:hover{background-size:50% 50%}a{color:var(--color-primary);text-decoration:none}a:hover{font-weight:700}a:focus,a:hover{text-decoration:none}.global-wrapper{margin:var(--spacing-0) auto;max-width:var(--maxWidth-wrapper);padding:0 var(--spacing-5)}.global-wrapper[data-is-root-path=true] .bio{margin-bottom:var(--spacing-20)}.global-header{margin-bottom:var(--spacing-12)}.main-heading{font-size:var(--fontSize-7);margin:0}.post-list-item{margin-bottom:var(--spacing-8);margin-top:var(--spacing-8)}.post-list-item p{margin-bottom:var(--spacing-0)}.post-list-item h2{color:var(--color-primary);font-size:var(--fontSize-4);margin-bottom:var(--spacing-2);margin-top:var(--spacing-0)}.post-list-item header{margin-bottom:var(--spacing-1)}.header-link-home{font-family:var(--font-heading);font-size:var(--fontSize-2);font-weight:var(--fontWeight-bold);text-decoration:none}.bio{display:flex;margin-bottom:var(--spacing-16)}.footer-bio{align-items:center;display:flex}.footer-bio p{margin:0}.bio p,.bio-avatar{margin-bottom:var(--spacing-0)}.bio-avatar{border-radius:100%;margin-right:var(--spacing-4);min-width:50px}.blog-post header h1{margin:var(--spacing-0) var(--spacing-0) var(--spacing-4) var(--spacing-0)}.blog-post header p{font-family:var(--font-heading);font-size:var(--fontSize-1)}.blog-post-nav ul{margin:var(--spacing-0)}.gatsby-highlight{margin-bottom:var(--spacing-6)}@media(max-width:42rem){blockquote{margin-left:var(--spacing-0);padding:var(--spacing-0) var(--spacing-0) var(--spacing-0) var(--spacing-4)}ol,ul{list-style-position:inside}}@font-face{font-family:firaCode-regular;src:url(/static/FiraCode-Regular-35c3227d50f2e1d4a23841be40da5a91.woff)}@font-face{font-family:firaCode-bold;src:url(/static/FiraCode-Bold-e98777879a1216397ac96e5c3c121c8e.woff)}.justify{text-align:justify}.grayscale{-webkit-filter:grayscale(.8);filter:grayscale(.8)}.social-icon{height:20px;width:20px}footer,footer a{display:flex}footer a{align-items:center;justify-content:center}footer>*{margin-right:9px}.blog-post{margin:var(--spacing-8) 0}.gatsby-resp-image-wrapper{max-width:none!important}code{font-size:1rem!important}code[class*=language-],pre[class*=language-]{word-wrap:normal;background:none;color:#000;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;-webkit-hyphens:none;hyphens:none;line-height:1.5;-o-tab-size:4;tab-size:4;text-align:left;text-shadow:0 1px #fff;white-space:pre;word-break:normal;word-spacing:normal}code[class*=language-] ::selection,code[class*=language-]::selection,pre[class*=language-] ::selection,pre[class*=language-]::selection{background:#b3d4fc;text-shadow:none}@media print{code[class*=language-],pre[class*=language-]{text-shadow:none}}pre[class*=language-]{margin:.5em 0;overflow:auto;padding:1em}:not(pre)>code[class*=language-],pre[class*=language-]{background:#f5f2f0}:not(pre)>code[class*=language-]{border-radius:.3em;padding:.1em;white-space:normal}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#708090}.token.punctuation{color:#999}.token.namespace{opacity:.7}.token.boolean,.token.constant,.token.deleted,.token.number,.token.property,.token.symbol,.token.tag{color:#905}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string{color:#690}.language-css .token.string,.style .token.string,.token.entity,.token.operator,.token.url{background:hsla(0,0%,100%,.5);color:#9a6e3a}.token.atrule,.token.attr-value,.token.keyword{color:#07a}.token.class-name,.token.function{color:#dd4a68}.token.important,.token.regex,.token.variable{color:#e90}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}.header-module--nav--piaz0 ul{align-items:center;display:flex;justify-content:flex-end;list-style:none}.header-module--nav--piaz0 ul li{margin-right:2rem}.header-module--nav--piaz0 ul li:not(:first-child){font-size:var(--fontSize-1)}.header-module--nav--piaz0 ul li a{color:#000;text-decoration:none}.header-module--nav--piaz0 ul :first-child{margin-right:auto}.header-module--logo--y97xu{font-family:firaCode-bold;font-size:x-large;letter-spacing:2px}.about-module--row--nmaoD{display:flex;flex-wrap:wrap;padding:0 4px}.about-module--column--mrOxT{flex:30% 1;max-width:35%;padding:0 4px}.about-module--imgMargin--kRAKI{margin-bottom:1.3rem}.about-module--column--mrOxT img{vertical-align:middle;width:100%}@media screen and (max-width:800px){.about-module--column--mrOxT{flex:50% 1;max-width:50%}}@media screen and (max-width:600px){.about-module--column--mrOxT{flex:100% 1;max-width:100%}}.pagination-module--pagenav--Vdn76{display:flex;justify-content:center;margin:3rem auto;max-width:var(--maxWidth-full);padding:0 2rem}.pagination-module--pagenav__item--Z5MIe{flex:0 0 25rem;margin:1rem}.pagination-module--pagenav__item--Z5MIe a{display:block;padding:2rem;text-align:center;text-decoration:none}.pagination-module--pagenav__item--Z5MIe a:focus,.pagination-module--pagenav__item--Z5MIe a:hover{background-color:#fff;text-decoration:none}</style><title data-gatsby-head="true">Designing a bursty a rate limiter | samya-ak</title><style>.gatsby-image-wrapper{position:relative;overflow:hidden}.gatsby-image-wrapper picture.object-fit-polyfill{position:static!important}.gatsby-image-wrapper img{bottom:0;height:100%;left:0;margin:0;max-width:none;padding:0;position:absolute;right:0;top:0;width:100%;object-fit:cover}.gatsby-image-wrapper [data-main-image]{opacity:0;transform:translateZ(0);transition:opacity .25s linear;will-change:opacity}.gatsby-image-wrapper-constrained{display:inline-block;vertical-align:top}</style><noscript><style>.gatsby-image-wrapper noscript [data-main-image]{opacity:1!important}.gatsby-image-wrapper [data-placeholder-image]{opacity:0!important}</style></noscript><script type="module">const e="undefined"!=typeof HTMLImageElement&&"loading"in HTMLImageElement.prototype;e&&document.body.addEventListener("load",(function(e){const t=e.target;if(void 0===t.dataset.mainImage)return;if(void 0===t.dataset.gatsbyImageSsr)return;let a=null,n=t;for(;null===a&&n;)void 0!==n.parentNode.dataset.gatsbyImageWrapper&&(a=n.parentNode),n=n.parentNode;const o=a.querySelector("[data-placeholder-image]"),r=new Image;r.src=t.currentSrc,r.decode().catch((()=>{})).then((()=>{t.style.opacity=1,o&&(o.style.opacity=0,o.style.transition="opacity 500ms linear")}))}),!0);</script><link rel="alternate" type="application/rss+xml" title="Gatsby Starter Blog RSS Feed" href="/rss.xml"/><link rel="icon" href="/favicon-32x32.png?v=e3f6f1328454f5f32789b945bcbce729" type="image/png"/><link rel="manifest" href="/manifest.webmanifest" crossorigin="anonymous"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=e3f6f1328454f5f32789b945bcbce729"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=e3f6f1328454f5f32789b945bcbce729"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=e3f6f1328454f5f32789b945bcbce729"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=e3f6f1328454f5f32789b945bcbce729"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=e3f6f1328454f5f32789b945bcbce729"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=e3f6f1328454f5f32789b945bcbce729"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=e3f6f1328454f5f32789b945bcbce729"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=e3f6f1328454f5f32789b945bcbce729"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div class="global-wrapper"><header><div class="header-module--nav--piaz0"><ul><li class="header-module--logo--y97xu"><a href="/">samya-ak</a></li><li><a href="/">Home</a></li><li><a href="/about">About</a></li></ul></div></header><hr/><main><article class="blog-post" itemscope="" itemType="http://schema.org/Article"><header><h1 itemProp="headline">Designing a bursty a rate limiter</h1><p>June 02, 2024</p></header><section itemProp="articleBody"><h4>Introduction</h4>
<p>“A rate limiter caps how many requests a sender can issue in a specific time window. It then blocks requests once the cap is reached.”</p>
<p>Some major reasons why we need rate limiting:</p>
<ul>
<li>To protect against misbehaving clients, DOS attacks, bruteforce attempts etc.</li>
<li>Encourages developers to follow good coding practices</li>
<li>Helps keep resource cost under control</li>
<li>To increase availability of service for everyone</li>
<li>Could be a revenue tactic for some services</li>
</ul>
<h4>System Architecture</h4>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/97e9ed33c6177fce73e737799c16af98/c230a/hl.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 58.282208588957054%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAC4jAAAuIwF4pT92AAACMklEQVQoz1WTS2/TQBRG+edskFiwYMsvoKyLKCoqIApqBWnT5uk2cZPYqRvHnhnPw48ukA7ymPSx+DT3juwz371z54WxJWVVs0lz9g+O2GxzlHKowiALg1AGVVifF9p67fJHWZTu9l60wLq5J1zGvHz9lmh9x+H7FetY0lSO2jkPLgpDJrWXUPoZUCqDkAW5UB3QusqfXFaNj9dxRl3WfL3a8HmckBWOKLdMk4JpollsDRvpSAvHtnBIXXqHLfQB2NpuocaUFMby977h3a8bXh0GDNeS4/6KfrDiIgjpT+aMFxEfj2P2DiKEdf7/vAVWTf0faDBVjW2aLnYViTAEiWIc55xcXNMLFlzMl/wehwxu1vwcxByehOTaeTPe4emXBNf2qaxITieIH0NkWaK1Jco0l8uMy0XKIEr5drZm//sd0zvF2SxhFGdME0kq7SPw/DTEupLClkSjOaveBGm6G40zQ38lGCy3TG8FR39CPnwaMoq23SHLLcNIkKonQFc7XFn7ppq6wTT3XT+NI8oMg6uQcZQxWSvOZxG9YM4oFkxuFeO19PEz4CxcYVyJzCQq2aCTDTLNKNKM2WzF2d4b+sGMXrTl/DricnLNMJbeWatB6/BpycNx0CVCIYVCyQIhpJ+7JM2ZzFdEqSSR1q9hvOE20yTC+ktrJXV3yx7Yzl5bsh8ZWz2U35asTTdS2scO08qWD/lOu1fybA47y9pPvVTaq30R7UdiF/v8yfpUSpOLgn9G53m2Fr8elAAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="High level architecture diagram"
        title="High-level-architecture-diagram"
        src="/static/97e9ed33c6177fce73e737799c16af98/a6d36/hl.png"
        srcset="/static/97e9ed33c6177fce73e737799c16af98/222b7/hl.png 163w,
/static/97e9ed33c6177fce73e737799c16af98/ff46a/hl.png 325w,
/static/97e9ed33c6177fce73e737799c16af98/a6d36/hl.png 650w,
/static/97e9ed33c6177fce73e737799c16af98/e548f/hl.png 975w,
/static/97e9ed33c6177fce73e737799c16af98/3c492/hl.png 1300w,
/static/97e9ed33c6177fce73e737799c16af98/c230a/hl.png 2059w"
        sizes="(max-width: 650px) 100vw, 650px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<p>Fig: Rate limiter using Token bucket algorithm</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/2ca16734318ef40bfa9750465edaefbc/11d70/cd1.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 74.23312883435584%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAABYlAAAWJQFJUiTwAAACe0lEQVQ4y51UTU9TQRRlpf4CE1i6Mv4B3Wj8B5q40bhxg+LSKMYFS1e6UDcIJsSFGhEbKeUrwUQoAkrUCg0CfdRSoB+0PGn7XvvefB8z0w+pTYjxJifvzryZk3PvPZk2z/OQy+WQz+dg7+VBCAFjDJRSg7/z+vrgfn2t77YRyqCjp28Mj15Pm1xKhf8JIQTadNL3bh7Hzt3B0bO3EfiwVPspoZT6Z+jgnFcJB6e+4tK9AVzofob3i+sthELKBrT6Qwkdx4HgFMViAV6l0pAuawRKyZbSpCFuhSF0XRc7qTSSW9tIZ7IoOU7TZSoUviX2DT5ZNrIF3+zXVdVDrw0h5wLhj3MIjU0gGBrD7PyCmVahWIRXcRFN7uH49RA6bo7iyNUAHk9Y1fIOtKSJkDKGzfgGrGgEseUIUom4ISSE6mNgPkX/ZAwPhn+gZzBqVB50QgshpEBk10X/Uhb937MIWjaMlZRCOF3Bq1gBwaSLtRJtKq/+bSWExN25DNoH1nDypYXTQ3G4lEMwioujCZx6sY4Tz1dxbWrLXGRCGuVCKghVQ23yhlAJjqRDEYrl8TaaQiTnod7u1V8ewjuOQbxIDne1UmBVhQozK7vo7F1EZ+9nPAyuAUoAkmM2TRGIUwz/pBjfJND9JpRCt2nI2kf3XMbgadQ2Pf1j7IVtdHSNoP3GCK48WQCnPhT10btcRud0CV0zDu5/ceG45aqtqI9b4R2ceWPhfGADlyeToEJCVG3DkNq1sZK0YWUcZAteo4oCkUiXBTJlAdtvNrjPJZIlgkSRwKHC9NUo1K8N8X1A6slyKMFqtiFmMIpXITlt7GtwRgHBDPQ5/eLo1+Y35Y9dOjkHzkgAAAAASUVORK5CYII='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="Container diagram"
        title="Container-diagram"
        src="/static/2ca16734318ef40bfa9750465edaefbc/a6d36/cd1.png"
        srcset="/static/2ca16734318ef40bfa9750465edaefbc/222b7/cd1.png 163w,
/static/2ca16734318ef40bfa9750465edaefbc/ff46a/cd1.png 325w,
/static/2ca16734318ef40bfa9750465edaefbc/a6d36/cd1.png 650w,
/static/2ca16734318ef40bfa9750465edaefbc/e548f/cd1.png 975w,
/static/2ca16734318ef40bfa9750465edaefbc/3c492/cd1.png 1300w,
/static/2ca16734318ef40bfa9750465edaefbc/11d70/cd1.png 1802w"
        sizes="(max-width: 650px) 100vw, 650px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<p>Fig: Container diagram for rate limiter</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/666fd4aff90670bef50b942709b30e21/fa60d/cd2.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 47.239263803680984%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAABYlAAAWJQFJUiTwAAABnUlEQVQoz4WSy2tUMRTG5y91IS4UcalduHLvriKIC/eKWIs7pT5gOtIiWKWVMg+w+KiF6czc3JvHSU5+cnNnxurGwJeTnJDz+r6ec45FVTFfdAgipJT+i5gSEv+g9YUQ6IkIYg3SVAWgZLqVcyZpRlubO1v86/0iQCTS8yHweBR4cOi4/9nxbOwgK0mVrPr3p6W/PU/mkc2DhoeHttj2TpIu4L1PDbcHho1+xaMju85Y+cTWxLM98TwZOr5MhdU6Phc2+oY7e4ZbfcNR+6aRXtv34Gdge2x5Pmr4cCbEKARbczJzXN2Zc/1txaWXC7aGBvUN4h0/6sTToeXFuC5dTV1CY6lQuPvRceOd4dqbis2Dmugt1lqiZk7qzHihDGeRudcy+Owb9k4Dl1/X3NytubJTMZpFUKHnvGf/ZM7ud8f7U+H4PLZslLa8c4itIfolS7om5uvZjFfDKYNvDfu/BBOUVCr0HmsWQFpxi5bBgzF1kVKbtGW7ELUMaGtDck2Z24q0wnJpIbPWVbygNV0GaO2/OsxLGcWknQ61G8dvY9SsDEDm/U4AAAAASUVORK5CYII='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="Component diagram"
        title="Component-diagram"
        src="/static/666fd4aff90670bef50b942709b30e21/a6d36/cd2.png"
        srcset="/static/666fd4aff90670bef50b942709b30e21/222b7/cd2.png 163w,
/static/666fd4aff90670bef50b942709b30e21/ff46a/cd2.png 325w,
/static/666fd4aff90670bef50b942709b30e21/a6d36/cd2.png 650w,
/static/666fd4aff90670bef50b942709b30e21/e548f/cd2.png 975w,
/static/666fd4aff90670bef50b942709b30e21/3c492/cd2.png 1300w,
/static/666fd4aff90670bef50b942709b30e21/fa60d/cd2.png 1792w"
        sizes="(max-width: 650px) 100vw, 650px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<p>Fig: Component diagram for rate limiter</p>
<h4>ERD</h4>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/eedd105b2d1de0cd0d62304ef66ddb42/18d55/erd.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 34.355828220858896%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAABYlAAAWJQFJUiTwAAABNElEQVQoz02RyY6DMBBE/f8fliiTQ5RtIkxALAPGeME2oBxr1D1DlEMJunlV7jbCWA89WujR4KdTLDVoDNpADSOcD4hpYfkpYjSO+a4f3jyJeOqLTEpcLhdImeN2u2G32+F+/0ZVVSiKAsMwcliaV/RqYPZ8PmO/3+N4POJw+GIf8XVdQzRNy8Z5nvF6vdA0DZucc1z7KWAKCSHOsM6zWUqJlBK8928v1TFGiLZt8Xw+uUkqyxKn04mDlVIwxnEgrRtCwuPxQNd1WNcVxhg+nDKI9X6C6PueIWstQzR2lmXI85zDacKQFp6Qgmk66i/LwlsQS/Xf9WiIoixxvV7R9wohRFRVzR/oNOc8/xQKo3scjf1fOYefJmitUdU1nPew1sE6B7GtQ9re6fkpCty0sZ/6ZH8BtnEGU4i2LEMAAAAASUVORK5CYII='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="ERD"
        title="ERD"
        src="/static/eedd105b2d1de0cd0d62304ef66ddb42/a6d36/erd.png"
        srcset="/static/eedd105b2d1de0cd0d62304ef66ddb42/222b7/erd.png 163w,
/static/eedd105b2d1de0cd0d62304ef66ddb42/ff46a/erd.png 325w,
/static/eedd105b2d1de0cd0d62304ef66ddb42/a6d36/erd.png 650w,
/static/eedd105b2d1de0cd0d62304ef66ddb42/e548f/erd.png 975w,
/static/eedd105b2d1de0cd0d62304ef66ddb42/3c492/erd.png 1300w,
/static/eedd105b2d1de0cd0d62304ef66ddb42/18d55/erd.png 2470w"
        sizes="(max-width: 650px) 100vw, 650px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<p>Fig: ER diagram showing relationship between merchants and their rate limiting rules</p>
<h4>Overview of proposed Rate Limiter</h4>
<p>From the above ER diagram, we are storing one or more rate limiting rules per merchant which may have different
priorities. Each merchant will be identified by an unique merchant id. Rate limits will be applied such that a
rule with higher priority is chosen for a merchant.</p>
<p>Also, this implementation provides Rules service which exposes APIs for administrators to manage rules
for each merchant.</p>
<p>For the implementation of Rate Limiter, Token bucket algorithm is used. This algorithm inherently handles
traffic bursts. This algorithm uses the concept of tokens in buckets. Empty bucket means upcoming
requests will be throttled until it is refilled. For its parameters, we provide bucket size or burst
size and refill rate. For the use case to handle traffic bursts, it’s advised to provide higher bucket
size than the refill rate.</p>
<h4>Token Bucket Algorithm</h4>
<p>The token bucket algorithm is a simple and popular mechanism for rate limiting that supports traffic bursts.
Three major components of this algorithm are Bucket, Token and Refill rate. Bucket is a container that
holds a certain number of tokens and bucket size signifies the burst capacity. Token represents the permission
to process the request. Refill rate is the rate at which tokens are added to the bucket.</p>
<p>Let’s look at some Go code for implementing the token bucket algorithm. It assumes a refill rate of n tokens
per second for brevity.</p>
<div class="gatsby-highlight" data-language="go"><pre class="language-go"><code class="language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
  <span class="token string">"sync"</span>
  <span class="token string">"time"</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> TokenBucket <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  maxTokens  <span class="token builtin">int64</span> <span class="token comment">// Bucket or burst size</span>
  fillRate   <span class="token builtin">int64</span> <span class="token comment">// n tokens per second for brevity</span>
  curTokens  <span class="token builtin">int64</span>
  lastRefill time<span class="token punctuation">.</span>Time
  mutex      sync<span class="token punctuation">.</span>Mutex
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">NewTokenBucket</span><span class="token punctuation">(</span>maxTokens<span class="token punctuation">,</span> fillRate <span class="token builtin">int64</span><span class="token punctuation">)</span> <span class="token operator">*</span>TokenBucket <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token operator">&amp;</span>TokenBucket<span class="token punctuation">{</span>
    maxTokens<span class="token punctuation">:</span>  maxTokens<span class="token punctuation">,</span>
    fillRate<span class="token punctuation">:</span>   fillRate<span class="token punctuation">,</span>
    curTokens<span class="token punctuation">:</span>  maxTokens<span class="token punctuation">,</span> <span class="token comment">// Initially filled with max tokens</span>
    lastRefill<span class="token punctuation">:</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    mutex<span class="token punctuation">:</span>      sync<span class="token punctuation">.</span>Mutex<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>bucket <span class="token operator">*</span>TokenBucket<span class="token punctuation">)</span> <span class="token function">AllowRequest</span><span class="token punctuation">(</span>tokens <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
  <span class="token comment">// Use lock to prevent race conditions while updating token size</span>
  bucket<span class="token punctuation">.</span>mutex<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">defer</span> bucket<span class="token punctuation">.</span>mutex<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  bucket<span class="token punctuation">.</span><span class="token function">refill</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token keyword">if</span> bucket<span class="token punctuation">.</span>curTokens <span class="token operator">>=</span> tokens <span class="token punctuation">{</span>
    bucket<span class="token punctuation">.</span>curTokens <span class="token operator">-=</span> tokens
    <span class="token keyword">return</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>bucket <span class="token operator">*</span>TokenBucket<span class="token punctuation">)</span> <span class="token function">refill</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  now <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  elapsed <span class="token operator">:=</span> now<span class="token punctuation">.</span><span class="token function">Sub</span><span class="token punctuation">(</span>bucket<span class="token punctuation">.</span>lastRefill<span class="token punctuation">)</span>
  tokensToAdd <span class="token operator">:=</span> <span class="token function">int64</span><span class="token punctuation">(</span>elapsed <span class="token operator">/</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span> <span class="token operator">*</span> bucket<span class="token punctuation">.</span>fillRate

  <span class="token comment">// Ensure bucket doesn't overflow</span>
  bucket<span class="token punctuation">.</span>curTokens <span class="token operator">=</span> <span class="token function">min</span><span class="token punctuation">(</span>bucket<span class="token punctuation">.</span>curTokens<span class="token operator">+</span>tokensToAdd<span class="token punctuation">,</span> bucket<span class="token punctuation">.</span>maxTokens<span class="token punctuation">)</span>
  bucket<span class="token punctuation">.</span>lastRefill <span class="token operator">=</span> now
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">min</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b <span class="token builtin">int64</span><span class="token punctuation">)</span> <span class="token builtin">int64</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> a <span class="token operator">&lt;</span> b <span class="token punctuation">{</span>
    <span class="token keyword">return</span> a
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> b
<span class="token punctuation">}</span></code></pre></div>
<p>Let’s look at an example on how traffic bursts are handled by this algorithm. Let’s assume the bucket
size is 10 and refill rate is 5 per second.</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/99ddfa19778c1055711680f3be09d80c/defc9/tba2.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 28.834355828220858%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAABYlAAAWJQFJUiTwAAABC0lEQVQY001R2Y7CMBDj/z9rL9SFBRqKaHM0k0yOsj/h1aRU7IPlxIo8HmdXckLJGTmtzDGCvG+Q838teI/E3DTh7d2miccup5fZUgussVC9ajDa4LFUaK3RX3oopTDPc9Occ+if75x1qKWsht0tQOmASASOAY4SujHje8xwxEiBMLmIg/nFUS9wPoIDYSbGYapNN14CJUi4nXYET7G5C2S92zRjGO1r5ZQwzYzRUbvX53raBYyWwMx41LomjOSRnx1I7EAEqyfcbwNiCOAQ0B8POO2/0L2/YbheYY1pfPo5Yv/5gcv5jPF+Xw3FaCt061KMl1pRSkGSKoYrWPVIw9AGCmTYxgL5HDH8A2ozsK2p4oXaAAAAAElFTkSuQmCC'); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="Token bucket algorithm"
        title="Token-bucket-algorithm"
        src="/static/99ddfa19778c1055711680f3be09d80c/a6d36/tba2.png"
        srcset="/static/99ddfa19778c1055711680f3be09d80c/222b7/tba2.png 163w,
/static/99ddfa19778c1055711680f3be09d80c/ff46a/tba2.png 325w,
/static/99ddfa19778c1055711680f3be09d80c/a6d36/tba2.png 650w,
/static/99ddfa19778c1055711680f3be09d80c/e548f/tba2.png 975w,
/static/99ddfa19778c1055711680f3be09d80c/3c492/tba2.png 1300w,
/static/99ddfa19778c1055711680f3be09d80c/defc9/tba2.png 2046w"
        sizes="(max-width: 650px) 100vw, 650px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<p>Fig: Traffic burst in Token bucket algorithm</p>
<ul>
<li>Bucket is initialised with max token size of 10</li>
<li>10 Requests worth of 10 tokens arrive simultaneously after 500 milliseconds causing the token size to deplete to 0</li>
<li>Next 2 requests come after 200 milliseconds. 200 milliseconds wait is worth 1 token since rate of refill is 5 tokens per seconds. 1 token is sent for processing while another token is dropped</li>
<li>Similarly, another request arrives after 1200 milliseconds wait which refills bucket with 6 tokens</li>
<li>After this, requests are processed in steady rate of 5 requests per second until another traffic burst</li>
</ul>
<h4>Storing token buckets</h4>
<p>Every time a background job is run, it fetches the rules for a chunk of merchants, creates bucket objects
from the rules and stores it in some in-memory cache like redis. Merchant id can be used as a key for each
bucket. With minimum overhead, Rate limiter can access the bucket for a specific merchant when the merchant
makes a transaction request.</p>
<p>Assuming millions of merchants exist in the system. Should we keep a bucket for each of them in the cache?
No. Buckets will have some expiration time and will be deleted if no requests are using the bucket for more
than refill rate. New bucket is created by the Rate limiter if the bucket is not found in cache for that
merchant.</p>
<h4>Distributed Rate Limiter and its challenges</h4>
<p>We can horizontally scale the rate limiter hosted in EC2 using Auto scaling group (ASG) and Load balancer.
When the load on rate limiter increases ASG scales out EC2 instances to match an increased load or scale
in to match decreased load. It automatically registers new instances to load balancer. Load balancer (LB)
is responsible for spreading load across multiple rate limiter instances.</p>
<p>Distributed environment brings few challenges. Assuming we will be maintaining a bucket cache in each host,
how many tokens should be assigned for each bucket of a merchant? Each bucket should be assigned the max number
of tokens it can store. Because in theory, all requests could land in the same host. In reality though,
most requests will probably be distributed to different hosts by LB.</p>
<p>So, how do we make sure that distributed requests do not consume more tokens than the bucket size?
To solve this problem, we should allow each host to talk to each other and share how many tokens
each host consumed altogether. Each host will subtract the sum collected from all the other hosts to get remaining
tokens.There’s still a chance that our system may be processing more requests than expected when all
requests arrive at the same time in each host and are unable to talk to each other.</p>
<p>There are few ways we can make each host talk to each other. Some popular message broadcasting ways are
consensus algorithms like paxos or raft, full mesh broadcasting - where each host is connected to
every other host. These are complex to implement, consumes huge network and storage resources. The simplest and
most popular way would be to use a central cache repository shared by all the hosts.</p>
<h4>Comparison with other algorithms</h4>
<h5>Fixed window algorithm</h5>
<p>It divides time into fixed-size windows and counts the number of requests in the current window.If the count exceeds the allowed limit, further requests are denied until the next window.</p>
<p>Although easy to implement, it cannot handle traffic bursts. Also, when requests arrive at the edges of two consecutive windows, the rate limit exceeds the applied rate limit rules.</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/ce2949f9ff95729c0175684d9bb10adf/e6c84/fwa.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 46.012269938650306%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAABYlAAAWJQFJUiTwAAAA7UlEQVQoz21SWw6EIAz0/scy2Y2PTdwfXXzgW/QW3UyTIUj8KANMp7S0ybHv4o5DgNyfznnjHX1CPtSRS8LLyzlpjZEiz+X9esmnLH1Q4GitlEUhWZZJmqYy9P3tUWDCwzxNsm+bXgK3dVWEYJlntes8lQenfKTVDPn6NI4+k7jkdVnUKERg8thD6wNiwcEYowQygRCG/beqpKlrsdYqoszQBw/1XafaW0A4MggNznYY5Nc0ihA++YDH//qS486yg0D8FV6HAMFiPzbrVnLY+ngMkBkE+KuubTWrp3HxXeYhNjqyLHYTGcdzG87hHw5Uj4k5XJ0RAAAAAElFTkSuQmCC'); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="Fixed window algorithm"
        title="Fixed window algorithm"
        src="/static/ce2949f9ff95729c0175684d9bb10adf/a6d36/fwa.png"
        srcset="/static/ce2949f9ff95729c0175684d9bb10adf/222b7/fwa.png 163w,
/static/ce2949f9ff95729c0175684d9bb10adf/ff46a/fwa.png 325w,
/static/ce2949f9ff95729c0175684d9bb10adf/a6d36/fwa.png 650w,
/static/ce2949f9ff95729c0175684d9bb10adf/e548f/fwa.png 975w,
/static/ce2949f9ff95729c0175684d9bb10adf/e6c84/fwa.png 1148w"
        sizes="(max-width: 650px) 100vw, 650px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<p>Fig: Fixed window algorithm</p>
<p>Let’s say there’s a rule that says requests should be dropped if the number of requests exceeds 5 requests per minute. In the fixed window algorithm, 5 requests arrive at 900ms of the first window - it is sent for processing. In another window, the request counter is reset and another 5 requests arrive after 100ms. These requests are sent for processing as well. Two chunks of requests arrived within a period of 200ms and 10 requests were sent for processing within the period. This far exceeds the rate limit rule we’ve set.</p>
<h5>Sliding window algorithm</h5>
<p>It is similar to Fixed Window but uses a sliding window to smooth out the boundary effects. The window slides over time and counts requests within the current window span. It is more accurate than the fixed window algorithm but is more complex to implement. Since it requires maintaining timestamps for each request, more storage and computation power is required.</p>
<h4>Rate limiting by IP vs User</h4>
<p>The issue with rate limiting by IP is that multiple users may share the same public IP address for example in places like cafe or smartphone users using the same internet gateway. One bad user may cause throttling for other users. Also, people using IPV6 have options to use multiple IPs from a single computer making it hard to track them.</p>
<p>Authenticated user’s token can be used to track the user and rate limit their requests. Weakness of this type of rate limiting might be that hackers may DOS attack against a specific user by entering wrong credentials.</p>
<p>We could take an approach where we use both IP and user token to track the user. Though, this approach will require more storage.</p>
<h4>Testing the efficiency of rate limiter</h4>
<p>We can use load testing tools like Locust to simulate different traffic scenarios like steady and burst. Next step would be to monitor and measure different metrics to validate if the rate limiter is working as expected. Following may be some of the metrics that need attention:</p>
<ul>
<li>Throughput: Number of requests per set interval for each merchant</li>
<li>Error Rate: Number of requests denied</li>
<li>CPU and memory usage by rate limiter and API services</li>
</ul></section><hr/></article><nav class="blog-post-nav"><ul style="display:flex;flex-wrap:wrap;justify-content:space-between;list-style:none;padding:0"><li><a rel="prev" href="/amend-commit/">← <!-- -->Amend an old commit in git<!-- --></a></li><li></li></ul></nav><footer><div class="footer-bio"><div data-gatsby-image-wrapper="" style="width:50px;height:50px" class="gatsby-image-wrapper bio-avatar"><div aria-hidden="true" data-placeholder-image="" style="opacity:1;transition:opacity 500ms linear;background-color:#686868;width:50px;height:50px;position:relative"></div><picture><source type="image/avif" data-srcset="/static/e3f6f1328454f5f32789b945bcbce729/d4bf4/profile-pic.avif 50w,/static/e3f6f1328454f5f32789b945bcbce729/ee81f/profile-pic.avif 100w" sizes="50px"/><source type="image/webp" data-srcset="/static/e3f6f1328454f5f32789b945bcbce729/3faea/profile-pic.webp 50w,/static/e3f6f1328454f5f32789b945bcbce729/6a679/profile-pic.webp 100w" sizes="50px"/><img data-gatsby-image-ssr="" layout="fixed" data-main-image="" style="opacity:0" sizes="50px" decoding="async" loading="lazy" data-src="/static/e3f6f1328454f5f32789b945bcbce729/d24ee/profile-pic.jpg" data-srcset="/static/e3f6f1328454f5f32789b945bcbce729/d24ee/profile-pic.jpg 50w,/static/e3f6f1328454f5f32789b945bcbce729/64618/profile-pic.jpg 100w" alt="Profile picture"/></picture><noscript><picture><source type="image/avif" srcSet="/static/e3f6f1328454f5f32789b945bcbce729/d4bf4/profile-pic.avif 50w,/static/e3f6f1328454f5f32789b945bcbce729/ee81f/profile-pic.avif 100w" sizes="50px"/><source type="image/webp" srcSet="/static/e3f6f1328454f5f32789b945bcbce729/3faea/profile-pic.webp 50w,/static/e3f6f1328454f5f32789b945bcbce729/6a679/profile-pic.webp 100w" sizes="50px"/><img data-gatsby-image-ssr="" layout="fixed" data-main-image="" style="opacity:0" sizes="50px" decoding="async" loading="lazy" src="/static/e3f6f1328454f5f32789b945bcbce729/d24ee/profile-pic.jpg" srcSet="/static/e3f6f1328454f5f32789b945bcbce729/d24ee/profile-pic.jpg 50w,/static/e3f6f1328454f5f32789b945bcbce729/64618/profile-pic.jpg 100w" alt="Profile picture"/></picture></noscript><script type="module">const t="undefined"!=typeof HTMLImageElement&&"loading"in HTMLImageElement.prototype;if(t){const t=document.querySelectorAll("img[data-main-image]");for(let e of t){e.dataset.src&&(e.setAttribute("src",e.dataset.src),e.removeAttribute("data-src")),e.dataset.srcset&&(e.setAttribute("srcset",e.dataset.srcset),e.removeAttribute("data-srcset"));const t=e.parentNode.querySelectorAll("source[data-srcset]");for(let e of t)e.setAttribute("srcset",e.dataset.srcset),e.removeAttribute("data-srcset");e.complete&&(e.style.opacity=1,e.parentNode.parentNode.querySelector("[data-placeholder-image]").style.opacity=0)}}</script></div><p>Written by <!-- --><strong>Samyak Maharjan</strong> <!-- --> <!-- --><a href="https://github.com/samya-ak">You should follow him on GitHub</a></p></div></footer></main><footer><a href="https://www.linkedin.com/in/samya-ak" target="_blank"><svg class="social-icon" viewBox="0 0 448 512"><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"></path></svg></a> <!-- --><a href="https://www.github.com/samya-ak" target="_blank"><svg class="social-icon" viewBox="0 0 496 512"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg></a> <!-- --><span>© </span> <!-- --><span>2024<!-- --></span> <!-- --></footer></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/rate-limiter/";window.___webpackCompilationHash="674b6b46e491f7a8b7e0";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-e7ee9b1387ab3dacc6d1.js"],"app":["/app-94d735843a6f89d015c9.js"],"component---src-pages-404-js":["/component---src-pages-404-js-27dbe7f22622bdeb9e83.js"],"component---src-pages-about-js":["/component---src-pages-about-js-3284794d33f5cbe2b2ab.js"],"component---src-pages-using-typescript-tsx":["/component---src-pages-using-typescript-tsx-7e9f6697a0e23fae060e.js"],"component---src-templates-blog-post-js":["/component---src-templates-blog-post-js-1ba2592025f1bd2c4d3b.js"],"component---src-templates-index-js":["/component---src-templates-index-js-62996ad41cff1ed3304a.js"],"component---src-templates-subjects-js":["/component---src-templates-subjects-js-27d8ed23782d53a27b44.js"]};/*]]>*/</script><script src="/polyfill-e7ee9b1387ab3dacc6d1.js" nomodule=""></script><script src="/app-94d735843a6f89d015c9.js" async=""></script><script src="/framework-08aa012d52ecdb9c1579.js" async=""></script><script src="/webpack-runtime-d15070c544c5b348aed9.js" async=""></script></body></html>