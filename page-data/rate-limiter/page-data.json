{"componentChunkName":"component---src-templates-blog-post-js","path":"/rate-limiter/","result":{"data":{"site":{"siteMetadata":{"title":"samya-ak"}},"markdownRemark":{"id":"c52a5c32-a848-5dec-9314-c329cb3e00e0","excerpt":"Introduction “A rate limiter caps how many requests a sender can issue in a specific time window. It then blocks requests once the cap is reached.” Some major…","html":"<h4>Introduction</h4>\n<p>“A rate limiter caps how many requests a sender can issue in a specific time window. It then blocks requests once the cap is reached.”</p>\n<p>Some major reasons why we need rate limiting:</p>\n<ul>\n<li>To protect against misbehaving clients, DOS attacks, bruteforce attempts etc.</li>\n<li>Encourages developers to follow good coding practices</li>\n<li>Helps keep resource cost under control</li>\n<li>To increase availability of service for everyone</li>\n<li>Could be a revenue tactic for some services</li>\n</ul>\n<h4>System Architecture</h4>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/97e9ed33c6177fce73e737799c16af98/c230a/hl.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 58.282208588957054%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAC4jAAAuIwF4pT92AAACMklEQVQoz1WTS2/TQBRG+edskFiwYMsvoKyLKCoqIApqBWnT5uk2cZPYqRvHnhnPw48ukA7ymPSx+DT3juwz371z54WxJWVVs0lz9g+O2GxzlHKowiALg1AGVVifF9p67fJHWZTu9l60wLq5J1zGvHz9lmh9x+H7FetY0lSO2jkPLgpDJrWXUPoZUCqDkAW5UB3QusqfXFaNj9dxRl3WfL3a8HmckBWOKLdMk4JpollsDRvpSAvHtnBIXXqHLfQB2NpuocaUFMby977h3a8bXh0GDNeS4/6KfrDiIgjpT+aMFxEfj2P2DiKEdf7/vAVWTf0faDBVjW2aLnYViTAEiWIc55xcXNMLFlzMl/wehwxu1vwcxByehOTaeTPe4emXBNf2qaxITieIH0NkWaK1Jco0l8uMy0XKIEr5drZm//sd0zvF2SxhFGdME0kq7SPw/DTEupLClkSjOaveBGm6G40zQ38lGCy3TG8FR39CPnwaMoq23SHLLcNIkKonQFc7XFn7ppq6wTT3XT+NI8oMg6uQcZQxWSvOZxG9YM4oFkxuFeO19PEz4CxcYVyJzCQq2aCTDTLNKNKM2WzF2d4b+sGMXrTl/DricnLNMJbeWatB6/BpycNx0CVCIYVCyQIhpJ+7JM2ZzFdEqSSR1q9hvOE20yTC+ktrJXV3yx7Yzl5bsh8ZWz2U35asTTdS2scO08qWD/lOu1fybA47y9pPvVTaq30R7UdiF/v8yfpUSpOLgn9G53m2Fr8elAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"High level architecture diagram\"\n        title=\"High-level-architecture-diagram\"\n        src=\"/static/97e9ed33c6177fce73e737799c16af98/a6d36/hl.png\"\n        srcset=\"/static/97e9ed33c6177fce73e737799c16af98/222b7/hl.png 163w,\n/static/97e9ed33c6177fce73e737799c16af98/ff46a/hl.png 325w,\n/static/97e9ed33c6177fce73e737799c16af98/a6d36/hl.png 650w,\n/static/97e9ed33c6177fce73e737799c16af98/e548f/hl.png 975w,\n/static/97e9ed33c6177fce73e737799c16af98/3c492/hl.png 1300w,\n/static/97e9ed33c6177fce73e737799c16af98/c230a/hl.png 2059w\"\n        sizes=\"(max-width: 650px) 100vw, 650px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>Fig: Rate limiter using Token bucket algorithm</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/2ca16734318ef40bfa9750465edaefbc/11d70/cd1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 74.23312883435584%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAABYlAAAWJQFJUiTwAAACe0lEQVQ4y51UTU9TQRRlpf4CE1i6Mv4B3Wj8B5q40bhxg+LSKMYFS1e6UDcIJsSFGhEbKeUrwUQoAkrUCg0CfdRSoB+0PGn7XvvefB8z0w+pTYjxJifvzryZk3PvPZk2z/OQy+WQz+dg7+VBCAFjDJRSg7/z+vrgfn2t77YRyqCjp28Mj15Pm1xKhf8JIQTadNL3bh7Hzt3B0bO3EfiwVPspoZT6Z+jgnFcJB6e+4tK9AVzofob3i+sthELKBrT6Qwkdx4HgFMViAV6l0pAuawRKyZbSpCFuhSF0XRc7qTSSW9tIZ7IoOU7TZSoUviX2DT5ZNrIF3+zXVdVDrw0h5wLhj3MIjU0gGBrD7PyCmVahWIRXcRFN7uH49RA6bo7iyNUAHk9Y1fIOtKSJkDKGzfgGrGgEseUIUom4ISSE6mNgPkX/ZAwPhn+gZzBqVB50QgshpEBk10X/Uhb937MIWjaMlZRCOF3Bq1gBwaSLtRJtKq/+bSWExN25DNoH1nDypYXTQ3G4lEMwioujCZx6sY4Tz1dxbWrLXGRCGuVCKghVQ23yhlAJjqRDEYrl8TaaQiTnod7u1V8ewjuOQbxIDne1UmBVhQozK7vo7F1EZ+9nPAyuAUoAkmM2TRGIUwz/pBjfJND9JpRCt2nI2kf3XMbgadQ2Pf1j7IVtdHSNoP3GCK48WQCnPhT10btcRud0CV0zDu5/ceG45aqtqI9b4R2ceWPhfGADlyeToEJCVG3DkNq1sZK0YWUcZAteo4oCkUiXBTJlAdtvNrjPJZIlgkSRwKHC9NUo1K8N8X1A6slyKMFqtiFmMIpXITlt7GtwRgHBDPQ5/eLo1+Y35Y9dOjkHzkgAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Container diagram\"\n        title=\"Container-diagram\"\n        src=\"/static/2ca16734318ef40bfa9750465edaefbc/a6d36/cd1.png\"\n        srcset=\"/static/2ca16734318ef40bfa9750465edaefbc/222b7/cd1.png 163w,\n/static/2ca16734318ef40bfa9750465edaefbc/ff46a/cd1.png 325w,\n/static/2ca16734318ef40bfa9750465edaefbc/a6d36/cd1.png 650w,\n/static/2ca16734318ef40bfa9750465edaefbc/e548f/cd1.png 975w,\n/static/2ca16734318ef40bfa9750465edaefbc/3c492/cd1.png 1300w,\n/static/2ca16734318ef40bfa9750465edaefbc/11d70/cd1.png 1802w\"\n        sizes=\"(max-width: 650px) 100vw, 650px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>Fig: Container diagram for rate limiter</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/666fd4aff90670bef50b942709b30e21/fa60d/cd2.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 47.239263803680984%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAABYlAAAWJQFJUiTwAAABnUlEQVQoz4WSy2tUMRTG5y91IS4UcalduHLvriKIC/eKWIs7pT5gOtIiWKWVMg+w+KiF6czc3JvHSU5+cnNnxurGwJeTnJDz+r6ec45FVTFfdAgipJT+i5gSEv+g9YUQ6IkIYg3SVAWgZLqVcyZpRlubO1v86/0iQCTS8yHweBR4cOi4/9nxbOwgK0mVrPr3p6W/PU/mkc2DhoeHttj2TpIu4L1PDbcHho1+xaMju85Y+cTWxLM98TwZOr5MhdU6Phc2+oY7e4ZbfcNR+6aRXtv34Gdge2x5Pmr4cCbEKARbczJzXN2Zc/1txaWXC7aGBvUN4h0/6sTToeXFuC5dTV1CY6lQuPvRceOd4dqbis2Dmugt1lqiZk7qzHihDGeRudcy+Owb9k4Dl1/X3NytubJTMZpFUKHnvGf/ZM7ud8f7U+H4PLZslLa8c4itIfolS7om5uvZjFfDKYNvDfu/BBOUVCr0HmsWQFpxi5bBgzF1kVKbtGW7ELUMaGtDck2Z24q0wnJpIbPWVbygNV0GaO2/OsxLGcWknQ61G8dvY9SsDEDm/U4AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Component diagram\"\n        title=\"Component-diagram\"\n        src=\"/static/666fd4aff90670bef50b942709b30e21/a6d36/cd2.png\"\n        srcset=\"/static/666fd4aff90670bef50b942709b30e21/222b7/cd2.png 163w,\n/static/666fd4aff90670bef50b942709b30e21/ff46a/cd2.png 325w,\n/static/666fd4aff90670bef50b942709b30e21/a6d36/cd2.png 650w,\n/static/666fd4aff90670bef50b942709b30e21/e548f/cd2.png 975w,\n/static/666fd4aff90670bef50b942709b30e21/3c492/cd2.png 1300w,\n/static/666fd4aff90670bef50b942709b30e21/fa60d/cd2.png 1792w\"\n        sizes=\"(max-width: 650px) 100vw, 650px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>Fig: Component diagram for rate limiter</p>\n<h4>ERD</h4>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/eedd105b2d1de0cd0d62304ef66ddb42/18d55/erd.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 34.355828220858896%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAABYlAAAWJQFJUiTwAAABNElEQVQoz02RyY6DMBBE/f8fliiTQ5RtIkxALAPGeME2oBxr1D1DlEMJunlV7jbCWA89WujR4KdTLDVoDNpADSOcD4hpYfkpYjSO+a4f3jyJeOqLTEpcLhdImeN2u2G32+F+/0ZVVSiKAsMwcliaV/RqYPZ8PmO/3+N4POJw+GIf8XVdQzRNy8Z5nvF6vdA0DZucc1z7KWAKCSHOsM6zWUqJlBK8928v1TFGiLZt8Xw+uUkqyxKn04mDlVIwxnEgrRtCwuPxQNd1WNcVxhg+nDKI9X6C6PueIWstQzR2lmXI85zDacKQFp6Qgmk66i/LwlsQS/Xf9WiIoixxvV7R9wohRFRVzR/oNOc8/xQKo3scjf1fOYefJmitUdU1nPew1sE6B7GtQ9re6fkpCty0sZ/6ZH8BtnEGU4i2LEMAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"ERD\"\n        title=\"ERD\"\n        src=\"/static/eedd105b2d1de0cd0d62304ef66ddb42/a6d36/erd.png\"\n        srcset=\"/static/eedd105b2d1de0cd0d62304ef66ddb42/222b7/erd.png 163w,\n/static/eedd105b2d1de0cd0d62304ef66ddb42/ff46a/erd.png 325w,\n/static/eedd105b2d1de0cd0d62304ef66ddb42/a6d36/erd.png 650w,\n/static/eedd105b2d1de0cd0d62304ef66ddb42/e548f/erd.png 975w,\n/static/eedd105b2d1de0cd0d62304ef66ddb42/3c492/erd.png 1300w,\n/static/eedd105b2d1de0cd0d62304ef66ddb42/18d55/erd.png 2470w\"\n        sizes=\"(max-width: 650px) 100vw, 650px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>Fig: ER diagram showing relationship between merchants and their rate limiting rules</p>\n<h4>Overview of proposed Rate Limiter</h4>\n<p>From the above ER diagram, we are storing one or more rate limiting rules per merchant which may have different\npriorities. Each merchant will be identified by an unique merchant id. Rate limits will be applied such that a\nrule with higher priority is chosen for a merchant.</p>\n<p>Also, this implementation provides Rules service which exposes APIs for administrators to manage rules\nfor each merchant.</p>\n<p>For the implementation of Rate Limiter, Token bucket algorithm is used. This algorithm inherently handles\ntraffic bursts. This algorithm uses the concept of tokens in buckets. Empty bucket means upcoming\nrequests will be throttled until it is refilled. For its parameters, we provide bucket size or burst\nsize and refill rate. For the use case to handle traffic bursts, it’s advised to provide higher bucket\nsize than the refill rate.</p>\n<h4>Token Bucket Algorithm</h4>\n<p>The token bucket algorithm is a simple and popular mechanism for rate limiting that supports traffic bursts.\nThree major components of this algorithm are Bucket, Token and Refill rate. Bucket is a container that\nholds a certain number of tokens and bucket size signifies the burst capacity. Token represents the permission\nto process the request. Refill rate is the rate at which tokens are added to the bucket.</p>\n<p>Let’s look at some Go code for implementing the token bucket algorithm. It assumes a refill rate of n tokens\nper second for brevity.</p>\n<div class=\"gatsby-highlight\" data-language=\"go\"><pre class=\"language-go\"><code class=\"language-go\"><span class=\"token keyword\">package</span> main\n\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">(</span>\n  <span class=\"token string\">\"sync\"</span>\n  <span class=\"token string\">\"time\"</span>\n<span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">type</span> TokenBucket <span class=\"token keyword\">struct</span> <span class=\"token punctuation\">{</span>\n  maxTokens  <span class=\"token builtin\">int64</span> <span class=\"token comment\">// Bucket or burst size</span>\n  fillRate   <span class=\"token builtin\">int64</span> <span class=\"token comment\">// n tokens per second for brevity</span>\n  curTokens  <span class=\"token builtin\">int64</span>\n  lastRefill time<span class=\"token punctuation\">.</span>Time\n  mutex      sync<span class=\"token punctuation\">.</span>Mutex\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token function\">NewTokenBucket</span><span class=\"token punctuation\">(</span>maxTokens<span class=\"token punctuation\">,</span> fillRate <span class=\"token builtin\">int64</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span>TokenBucket <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token operator\">&amp;</span>TokenBucket<span class=\"token punctuation\">{</span>\n    maxTokens<span class=\"token punctuation\">:</span>  maxTokens<span class=\"token punctuation\">,</span>\n    fillRate<span class=\"token punctuation\">:</span>   fillRate<span class=\"token punctuation\">,</span>\n    curTokens<span class=\"token punctuation\">:</span>  maxTokens<span class=\"token punctuation\">,</span> <span class=\"token comment\">// Initially filled with max tokens</span>\n    lastRefill<span class=\"token punctuation\">:</span> time<span class=\"token punctuation\">.</span><span class=\"token function\">Now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    mutex<span class=\"token punctuation\">:</span>      sync<span class=\"token punctuation\">.</span>Mutex<span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>bucket <span class=\"token operator\">*</span>TokenBucket<span class=\"token punctuation\">)</span> <span class=\"token function\">AllowRequest</span><span class=\"token punctuation\">(</span>tokens <span class=\"token builtin\">int</span><span class=\"token punctuation\">)</span> <span class=\"token builtin\">bool</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// Use lock to prevent race conditions while updating token size</span>\n  bucket<span class=\"token punctuation\">.</span>mutex<span class=\"token punctuation\">.</span><span class=\"token function\">Lock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">defer</span> bucket<span class=\"token punctuation\">.</span>mutex<span class=\"token punctuation\">.</span><span class=\"token function\">Unlock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  bucket<span class=\"token punctuation\">.</span><span class=\"token function\">refill</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n  <span class=\"token keyword\">if</span> bucket<span class=\"token punctuation\">.</span>curTokens <span class=\"token operator\">>=</span> tokens <span class=\"token punctuation\">{</span>\n    bucket<span class=\"token punctuation\">.</span>curTokens <span class=\"token operator\">-=</span> tokens\n    <span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>bucket <span class=\"token operator\">*</span>TokenBucket<span class=\"token punctuation\">)</span> <span class=\"token function\">refill</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  now <span class=\"token operator\">:=</span> time<span class=\"token punctuation\">.</span><span class=\"token function\">Now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  elapsed <span class=\"token operator\">:=</span> now<span class=\"token punctuation\">.</span><span class=\"token function\">Sub</span><span class=\"token punctuation\">(</span>bucket<span class=\"token punctuation\">.</span>lastRefill<span class=\"token punctuation\">)</span>\n  tokensToAdd <span class=\"token operator\">:=</span> <span class=\"token function\">int64</span><span class=\"token punctuation\">(</span>elapsed <span class=\"token operator\">/</span> time<span class=\"token punctuation\">.</span>Second<span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> bucket<span class=\"token punctuation\">.</span>fillRate\n\n  <span class=\"token comment\">// Ensure bucket doesn't overflow</span>\n  bucket<span class=\"token punctuation\">.</span>curTokens <span class=\"token operator\">=</span> <span class=\"token function\">min</span><span class=\"token punctuation\">(</span>bucket<span class=\"token punctuation\">.</span>curTokens<span class=\"token operator\">+</span>tokensToAdd<span class=\"token punctuation\">,</span> bucket<span class=\"token punctuation\">.</span>maxTokens<span class=\"token punctuation\">)</span>\n  bucket<span class=\"token punctuation\">.</span>lastRefill <span class=\"token operator\">=</span> now\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token function\">min</span><span class=\"token punctuation\">(</span>a<span class=\"token punctuation\">,</span> b <span class=\"token builtin\">int64</span><span class=\"token punctuation\">)</span> <span class=\"token builtin\">int64</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> a <span class=\"token operator\">&lt;</span> b <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> a\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">return</span> b\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Let’s look at an example on how traffic bursts are handled by this algorithm. Let’s assume the bucket\nsize is 10 and refill rate is 5 per second.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/99ddfa19778c1055711680f3be09d80c/defc9/tba2.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 28.834355828220858%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAABYlAAAWJQFJUiTwAAABC0lEQVQY001R2Y7CMBDj/z9rL9SFBRqKaHM0k0yOsj/h1aRU7IPlxIo8HmdXckLJGTmtzDGCvG+Q838teI/E3DTh7d2miccup5fZUgussVC9ajDa4LFUaK3RX3oopTDPc9Occ+if75x1qKWsht0tQOmASASOAY4SujHje8xwxEiBMLmIg/nFUS9wPoIDYSbGYapNN14CJUi4nXYET7G5C2S92zRjGO1r5ZQwzYzRUbvX53raBYyWwMx41LomjOSRnx1I7EAEqyfcbwNiCOAQ0B8POO2/0L2/YbheYY1pfPo5Yv/5gcv5jPF+Xw3FaCt061KMl1pRSkGSKoYrWPVIw9AGCmTYxgL5HDH8A2ozsK2p4oXaAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Token bucket algorithm\"\n        title=\"Token-bucket-algorithm\"\n        src=\"/static/99ddfa19778c1055711680f3be09d80c/a6d36/tba2.png\"\n        srcset=\"/static/99ddfa19778c1055711680f3be09d80c/222b7/tba2.png 163w,\n/static/99ddfa19778c1055711680f3be09d80c/ff46a/tba2.png 325w,\n/static/99ddfa19778c1055711680f3be09d80c/a6d36/tba2.png 650w,\n/static/99ddfa19778c1055711680f3be09d80c/e548f/tba2.png 975w,\n/static/99ddfa19778c1055711680f3be09d80c/3c492/tba2.png 1300w,\n/static/99ddfa19778c1055711680f3be09d80c/defc9/tba2.png 2046w\"\n        sizes=\"(max-width: 650px) 100vw, 650px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>Fig: Traffic burst in Token bucket algorithm</p>\n<ul>\n<li>Bucket is initialised with max token size of 10</li>\n<li>10 Requests worth of 10 tokens arrive simultaneously after 500 milliseconds causing the token size to deplete to 0</li>\n<li>Next 2 requests come after 200 milliseconds. 200 milliseconds wait is worth 1 token since rate of refill is 5 tokens per seconds. 1 token is sent for processing while another token is dropped</li>\n<li>Similarly, another request arrives after 1200 milliseconds wait which refills bucket with 6 tokens</li>\n<li>After this, requests are processed in steady rate of 5 requests per second until another traffic burst</li>\n</ul>\n<h4>Storing token buckets</h4>\n<p>Every time a background job is run, it fetches the rules for a chunk of merchants, creates bucket objects\nfrom the rules and stores it in some in-memory cache like redis. Merchant id can be used as a key for each\nbucket. With minimum overhead, Rate limiter can access the bucket for a specific merchant when the merchant\nmakes a transaction request.</p>\n<p>Assuming millions of merchants exist in the system. Should we keep a bucket for each of them in the cache?\nNo. Buckets will have some expiration time and will be deleted if no requests are using the bucket for more\nthan refill rate. New bucket is created by the Rate limiter if the bucket is not found in cache for that\nmerchant.</p>\n<h4>Distributed Rate Limiter and its challenges</h4>\n<p>We can horizontally scale the rate limiter hosted in EC2 using Auto scaling group (ASG) and Load balancer.\nWhen the load on rate limiter increases ASG scales out EC2 instances to match an increased load or scale\nin to match decreased load. It automatically registers new instances to load balancer. Load balancer (LB)\nis responsible for spreading load across multiple rate limiter instances.</p>\n<p>Distributed environment brings few challenges. Assuming we will be maintaining a bucket cache in each host,\nhow many tokens should be assigned for each bucket of a merchant? Each bucket should be assigned the max number\nof tokens it can store. Because in theory, all requests could land in the same host. In reality though,\nmost requests will probably be distributed to different hosts by LB.</p>\n<p>So, how do we make sure that distributed requests do not consume more tokens than the bucket size?\nTo solve this problem, we should allow each host to talk to each other and share how many tokens\neach host consumed altogether. Each host will subtract the sum collected from all the other hosts to get remaining\ntokens.There’s still a chance that our system may be processing more requests than expected when all\nrequests arrive at the same time in each host and are unable to talk to each other.</p>\n<p>There are few ways we can make each host talk to each other. Some popular message broadcasting ways are\nconsensus algorithms like paxos or raft, full mesh broadcasting - where each host is connected to\nevery other host. These are complex to implement, consumes huge network and storage resources. The simplest and\nmost popular way would be to use a central cache repository shared by all the hosts.</p>\n<h4>Comparison with other algorithms</h4>\n<h5>Fixed window algorithm</h5>\n<p>It divides time into fixed-size windows and counts the number of requests in the current window.If the count exceeds the allowed limit, further requests are denied until the next window.</p>\n<p>Although easy to implement, it cannot handle traffic bursts. Also, when requests arrive at the edges of two consecutive windows, the rate limit exceeds the applied rate limit rules.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/ce2949f9ff95729c0175684d9bb10adf/e6c84/fwa.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 46.012269938650306%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAABYlAAAWJQFJUiTwAAAA7UlEQVQoz21SWw6EIAz0/scy2Y2PTdwfXXzgW/QW3UyTIUj8KANMp7S0ybHv4o5DgNyfznnjHX1CPtSRS8LLyzlpjZEiz+X9esmnLH1Q4GitlEUhWZZJmqYy9P3tUWDCwzxNsm+bXgK3dVWEYJlntes8lQenfKTVDPn6NI4+k7jkdVnUKERg8thD6wNiwcEYowQygRCG/beqpKlrsdYqoszQBw/1XafaW0A4MggNznYY5Nc0ihA++YDH//qS486yg0D8FV6HAMFiPzbrVnLY+ngMkBkE+KuubTWrp3HxXeYhNjqyLHYTGcdzG87hHw5Uj4k5XJ0RAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Fixed window algorithm\"\n        title=\"Fixed window algorithm\"\n        src=\"/static/ce2949f9ff95729c0175684d9bb10adf/a6d36/fwa.png\"\n        srcset=\"/static/ce2949f9ff95729c0175684d9bb10adf/222b7/fwa.png 163w,\n/static/ce2949f9ff95729c0175684d9bb10adf/ff46a/fwa.png 325w,\n/static/ce2949f9ff95729c0175684d9bb10adf/a6d36/fwa.png 650w,\n/static/ce2949f9ff95729c0175684d9bb10adf/e548f/fwa.png 975w,\n/static/ce2949f9ff95729c0175684d9bb10adf/e6c84/fwa.png 1148w\"\n        sizes=\"(max-width: 650px) 100vw, 650px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>Fig: Fixed window algorithm</p>\n<p>Let’s say there’s a rule that says requests should be dropped if the number of requests exceeds 5 requests per minute. In the fixed window algorithm, 5 requests arrive at 900ms of the first window - it is sent for processing. In another window, the request counter is reset and another 5 requests arrive after 100ms. These requests are sent for processing as well. Two chunks of requests arrived within a period of 200ms and 10 requests were sent for processing within the period. This far exceeds the rate limit rule we’ve set.</p>\n<h5>Sliding window algorithm</h5>\n<p>It is similar to Fixed Window but uses a sliding window to smooth out the boundary effects. The window slides over time and counts requests within the current window span. It is more accurate than the fixed window algorithm but is more complex to implement. Since it requires maintaining timestamps for each request, more storage and computation power is required.</p>\n<h4>Rate limiting by IP vs User</h4>\n<p>The issue with rate limiting by IP is that multiple users may share the same public IP address for example in places like cafe or smartphone users using the same internet gateway. One bad user may cause throttling for other users. Also, people using IPV6 have options to use multiple IPs from a single computer making it hard to track them.</p>\n<p>Authenticated user’s token can be used to track the user and rate limit their requests. Weakness of this type of rate limiting might be that hackers may DOS attack against a specific user by entering wrong credentials.</p>\n<p>We could take an approach where we use both IP and user token to track the user. Though, this approach will require more storage.</p>\n<h4>Testing the efficiency of rate limiter</h4>\n<p>We can use load testing tools like Locust to simulate different traffic scenarios like steady and burst. Next step would be to monitor and measure different metrics to validate if the rate limiter is working as expected. Following may be some of the metrics that need attention:</p>\n<ul>\n<li>Throughput: Number of requests per set interval for each merchant</li>\n<li>Error Rate: Number of requests denied</li>\n<li>CPU and memory usage by rate limiter and API services</li>\n</ul>","frontmatter":{"title":"Designing a bursty rate limiter","date":"June 02, 2024","description":"A rate limiter caps how many requests a sender can issue in a specific time window. It then blocks requests once the cap is reached."}},"previous":{"fields":{"slug":"/amend-commit/"},"frontmatter":{"title":"Amend an old commit in git"}},"next":null},"pageContext":{"id":"c52a5c32-a848-5dec-9314-c329cb3e00e0","previousPostId":"5fa8998b-0f29-5838-bd75-d23783915f18","nextPostId":null}},"staticQueryHashes":["230163734","3589320610","754622331"]}